#!/bin/zsh -x

emerge -uDN $@ world

if `return $?`
then
else
    revdep-rebuild

    if hash haskell-updater
    then
        haskell-updater
    fi

    if hash perl-cleaner
    then
        perl-cleaner --all
    fi

    emerge --backtrack=100 @preserved-rebuild
    emerge -uDN --backtrack=100 world
fi
